define(["core","tpl"],function(o,e){var a={minimumcharge:0,wechat:0,alipay:0,couponid:0,coupons:[],payid:0,init:function(e){a.minimumcharge=e.minimumcharge,a.wechat=e.wechat,a.alipay=e.alipay,a.payid=e.payid,window.couponid=a.couponid,$("#money").bind("input propertychange",function(){a.hideCoupon(),$("#btn-next").addClass("disabled").show(),$(".btn-pay").hide(),$(".applyradio").hide(),$(this).isNumber()&&!$(this).isEmpty()&&0<parseFloat($(this).val())&&$("#btn-next").removeClass("disabled")}),$("#btn-next").click(function(){var e=$.trim($("#money").val()),t=!1;if(!$(this).attr("submit")){if(!$.isEmpty(e)&&$.isNumber(e)&&0<parseFloat(e))if(0<a.minimumcharge){if(parseFloat(e)<a.minimumcharge)return void FoxUI.toast.show("最低充值金额为"+a.minimumcharge+"元!");t=!0}else t=!0;t&&($(this).attr("submit","1"),o.json("sale/coupon/util/query",{money:e,type:1},function(t){return 1!=t.status?($("#btn-next").removeAttr("submit"),void o.tip.show(t.result)):(0<t.result.coupons.length?($("#coupondiv").show().find(".badge").html(t.result.coupons.length).show(),$("#coupondiv").find(".text").hide(),$("#coupondiv").click(function(){require(["biz/sale/coupon/picker"],function(e){e.show({couponid:a.couponid,coupons:t.result.coupons,onCancel:function(){window.couponid=a.couponid=0,$("#coupondiv").find(".fui-cell-label").html("优惠券"),$("#coupondiv").find(".fui-cell-info").html("")},onSelected:function(e){$("#coupondiv").find(".fui-cell-label").html("已选择"),$("#coupondiv").find(".fui-cell-info").html(e.couponame),window.couponid=a.couponid=e.couponid}})})})):a.hideCoupon(),$("#btn-next").removeAttr("submit").hide(),o.ish5app()?($("#btn-wechat1").css("display","flex"),$("#btn-wechat").show(),void $("#btn-alipay1").css("display","flex")):(a.wechat&&($("#btn-wechat1").css("display","flex"),$("#btn-wechat").show()),void(a.alipay&&$("#btn-alipay1").css("display","flex"))))},!0,!0))}}),$(document).on("click","#btn-wechat",function(){if(!$(".btn-pay").attr("submit")){var n=$("#money").val();n<=0?FoxUI.toast.show("充值金额必须大于0!"):$("#money").isNumber()?($(".btn-pay").attr("submit",1),o.json("member/recharge/submit",{type:"wechat",money:n,couponid:a.couponid},function(i){if(1!=i.status)return $(".btn-pay").removeAttr("submit"),void FoxUI.toast.show(i.result.message);if(o.ish5app())appPay("wechat",i.result.logno,i.result.money,!0);else{var e=i.result.wechat;if(e.weixin){function t(){WeixinJSBridge.invoke("getBrandWCPayRequest",{appId:e.appid?e.appid:e.appId,timeStamp:e.timeStamp,nonceStr:e.nonceStr,package:e.package,signType:e.signType,paySign:e.paySign},function(e){if("get_brand_wcpay_request:ok"==e.err_msg)var t=setInterval(function(){o.json("member/recharge/wechat_complete",{logid:i.result.logid},function(e){if(1==e.status)return clearInterval(t),FoxUI.toast.show("充值成功!"),0<a.payid?(location.href=o.getUrl("order/pay",{id:a.payid}),!1):void(location.href=o.getUrl("member"))},!0,!0)},2e3);else"get_brand_wcpay_request:cancel"==e.err_msg?($(".btn-pay").removeAttr("submit"),FoxUI.toast.show("取消支付")):o.json("member/recharge/submit",{type:"wechat",money:n,couponid:a.couponid,jie:1},function(e){a.payWechatJie(e.result,n)},!1,!0)})}"undefined"==typeof WeixinJSBridge?document.addEventListener?document.addEventListener("WeixinJSBridgeReady",t,!1):document.attachEvent&&(document.attachEvent("WeixinJSBridgeReady",t),document.attachEvent("onWeixinJSBridgeReady",t)):t()}!e.weixin_jie&&1!=e.jie||a.payWechatJie(i.result,n)}},!0,!0)):FoxUI.toast.show("请输入数字金额!")}}),$(document).on("click","#btn-alipay",function(){if(!$(".btn-pay").attr("submit")||o.ish5app())if(t<=0)FoxUI.toast.show("充值金额必须大于0!");else{var t=$("#money").val();$("#money").isNumber()?($(".btn-pay").attr("submit",1),o.json("member/recharge/submit",{type:"alipay",money:t,couponid:a.couponid},function(e){if(1!=e.status)return $(".btn-pay").removeAttr("submit"),void FoxUI.toast.show(e.result.message);o.ish5app()?appPay("alipay",e.result.logno,t,"1",null,!0):location.href=o.getUrl("order/pay_alipay",{orderid:e.result.logno,type:1,url:e.result.alipay.url})},!0,!0)):FoxUI.toast.show("请输入数字金额!")}})},payWechatJie:function(e,t){var i=o.getUrl("index/qr",{url:e.wechat.code_url});$("#qrmoney").text(t),$("#btnWeixinJieCancel").unbind("click").click(function(){$(".btn-pay").removeAttr("submit"),clearInterval(n),$(".order-weixinpay-hidden").hide()}),$(".order-weixinpay-hidden").show();var n=setInterval(function(){o.json("member/recharge/wechat_complete",{logid:e.logid},function(e){1!=e.status||(location.href=o.getUrl("member"))},!1,!0)},1e3);$(".verify-pop").find(".close").unbind("click").click(function(){$(".order-weixinpay-hidden").hide(),$(".btn-pay").removeAttr("submit"),clearInterval(n)}),$(".verify-pop").find(".qrimg").attr("src",i).show()},hideCoupon:function(){$("#coupondiv").hide(),$("#coupondiv").find(".badge").html("0").hide(),$("#coupondiv").find(".text").show()}};return a});