define(["core","tpl","biz/member/cart","biz/plugin/diyform","swiper"],function(i,n,o,e,t){var d={goodsid:0,goods:[],option:!1,spec1items:[],spec2items:[],options:[],hasoption:0,buyoptions:[],params:{selectoption:[],onConfirm:!1,autoClose:!0},open:function(o){d.params=$.extend(d.params,o||{}),d.goodsid!=o.goodsid?(d.goodsid=o.goodsid,i.json("goods/wholesalepicker",{id:o.goodsid},function(o){if(0!=o.status){if(d.followtip="",d.followurl="",2==o.status)return d.followtip=o.result.followtip,d.followurl=o.result.followurl,d.followqrcode=o.result.followqrcode,""!=d.followqrcode&&null!=d.followqrcode&&(d.containerFollowHTML=n("followqrcode",o.result)),void d.show();if(4==o.status)return d.needlogin=1,void d.show();if(3==o.status)return d.mustbind=1,void d.show();d.containerHTML=n("option-wholesalepicker",o.result),d.goods=o.result.goods,d.spec1items=o.result.spec1items,d.spec2items=o.result.spec2items,d.options=o.result.options,d.hasoption=o.result.hasoption,""==d.goods.unit&&(d.goods.unit="件"),d.show()}else FoxUI.toast.show("未找到商品!")},!0,!1)):d.show()},close:function(){d.container.close()},init:function(){if(2==d.hasoption){$(".btnitem1",d.container.container).unbind("click").click(function(){var o=$(this).data("id");$(".btnitem1",d.container.container).removeClass("active"),$(this).addClass("active"),$(".body",d.container.container).hide(),$("#body_"+o,d.container.container).show()});var o=d.spec1items[0].id;$(".btnitem1",d.container.container).removeClass("active"),$("#item1_"+o,d.container.container).addClass("active"),$(".body",d.container.container).hide(),$("#body_"+o,d.container.container).show()}$(".cartbtn",d.container.container).unbind("click").click(function(){d.addToCart()}),$(".icon-guanbi1",d.container.container).unbind("click").click(function(){d.close()}),$(".buybtn",d.container.container).unbind("click").click(function(){if(!$(this).hasClass("disabled")&&d.check()){if(0<$(".diyform-container").length){var o=e.getData(".diyform-container");if(!o)return;i.json("order/create/diyform",{id:d.goods.id,diyformdata:o},function(o){location.href=i.getUrl("order/create",{id:d.goods.id,iswholesale:1,buyoptions:window.JSON.stringify(d.buyoptions),gdid:o.result.goods_data_id})},!0,!0)}else location.href=i.getUrl("order/create",{id:d.goods.id,iswholesale:1,buyoptions:window.JSON.stringify(d.buyoptions)});d.params.autoClose&&d.close()}}),$(".confirmbtn",d.container.container).unbind("click").click(function(){$(this).hasClass("disabled")||d.check()&&(d.params.onConfirm&&d.params.onConfirm(d.buyoptions),d.params.autoClose&&d.close())});new Swiper(".swiper-container",{paginationClickable:!0,slidesPerView:3,nextButton:".go-right",prevButton:".go-left"});$(".closebtn",d.container.container).unbind("click").click(function(){d.close()}),$(".fui-mask").unbind("click").click(function(){d.close()}),$(".fui-number",d.container.container).each(function(){var o=$(this).prev().find("span").html(),n=$(this).parents(".optiondata");0<o||-1==o?$(this).numbers({value:0,min:0,max:o,canzero:1,maxToast:"不能大于剩余库存",callback:function(o){n.attr("data-total",o),d.caculate()}}):$(this).find(".num").attr("disabled",!0)});var n=.5*$(document.body).height(),t=n-$(".option-picker-cell").outerHeight()-$(".option-picker .fui-navbar").outerHeight();d.container.container.find(".option-picker").css("height",n),d.container.container.find(".option-picker .option-picker-inner ").css("height",t)},caculate:function(){d.goods.intervalfloor;var t=0,o=0,i=[];$(".optiondata",d.container.container).each(function(){var o=parseInt($(this).attr("data-total"));t+=o;var n=$(this).attr("data-optionid");i[i.length]={optionid:n,total:o}}),d.buyoptions=i,2==d.hasoption&&$(".body",d.container.container).each(function(){var o=$(this).attr("data-id"),n=0;$(this).find(".optiondata").each(function(){n+=parseInt($(this).attr("data-total"))}),0<n?$("#item1_"+o,d.container.container).find(".dot").show().html(n):$("#item1_"+o,d.container.container).find(".dot").hide().html("")});var n=d.goods.intervalnum1,e=d.goods.intervalprice1,a=d.goods.intervalnum2,r=d.goods.intervalprice2,c=d.goods.intervalnum3,s=d.goods.intervalprice3;if(c<=t&&2<d.goods.intervalfloor){$("#UnitPrice",d.container.container).html("单价: ￥"+s+"/"+d.goods.unit+" 共"+t+d.goods.unit);o=s*t;$("#totalprice",d.container.container).html(o.toFixed(2)),$("#again",d.container.container).hide()}else if(a<=t&&1<d.goods.intervalfloor){$("#UnitPrice",d.container.container).html("单价: ￥"+r+"/"+d.goods.unit+" 共"+t+d.goods.unit);o=r*t;if($("#totalprice",d.container.container).html(o.toFixed(2)),2<d.goods.intervalfloor){var l=c-t;$("#again",d.container.container).show().html("再购买"+l+d.goods.unit+"享受￥"+s+"/"+d.goods.unit+"的价格")}else $("#again",d.container.container).hide()}else if(n<=t&&0<d.goods.intervalfloor){$("#UnitPrice",d.container.container).html("单价: ￥"+e+"/"+d.goods.unit+" 共"+t+d.goods.unit);o=e*t;if($("#totalprice",d.container.container).html(o.toFixed(2)),1<d.goods.intervalfloor){l=a-t;$("#again",d.container.container).show().html("再购买"+l+d.goods.unit+"享受￥"+r+"/"+d.goods.unit+"的价格")}else $("#again",d.container.container).hide()}else if(t<n){l=n-t;$("#again",d.container.container).show().html("再购买"+l+d.goods.unit+"达到最低起批数量"),$("#UnitPrice",d.container.container).html("您已选购"+t+d.goods.unit+"商品"),$("#totalprice",d.container.container).html(0)}},show:function(){if(d.followtip)FoxUI.confirm(d.followtip,function(){""!=d.followqrcode&&null!=d.followqrcode?(follow_container=new FoxUIModal({content:d.containerFollowHTML,extraClass:"popup-modal",maskClick:function(){follow_container.close()}}),$(".verify-pop").find(".qrimg").attr("src",d.followqrcode).show(),follow_container.show(),console.log(follow_container),$(".verify-pop").find(".close").unbind("click").click(function(){follow_container.close()})):""!=d.followurl&&null!=d.followurl&&(location.href=d.followurl)});else{if(d.needlogin){var o=i.getUrl("goods/detail",{id:d.goodsid});return o=o.replace("./index.php?",""),void FoxUI.confirm("请先登录","提示",function(){location.href=i.getUrl("account/login",{backurl:btoa(o)})})}d.mustbind?FoxUI.alert("请先绑定手机","提示",function(){location.href=i.getUrl("member/bind",{backurl:btoa(location.href)})}):(d.container=new FoxUIModal({content:d.containerHTML,extraClass:"picker-modal"}),d.init(),d.caculate(),$(".fui-mask").show(),$(".picker-modal").show(),d.params.showConfirm?$(".confirmbtn",d.container.container).show():($(".buybtn",d.container.container).show(),d.goods.canAddCart&&$(".cartbtn",d.container.container).show()),d.container.show())}},addToCart:function(){$(this).hasClass("disabled")||d.check()&&(d.params.total=parseInt($(".num",d.container.container).val()),o.addwholesale(d.goodsid,d.buyoptions,function(o){FoxUI.toast.show("添加成功"),d.changeCartcount(o.cartcount)}),d.params.autoClose&&d.close())},check:function(){if(d.goods.intervalfloor<=0)return FoxUI.toast.show("商品价格信息错误!"),!1;for(var o=0,n=0;n<d.buyoptions.length;n++)o+=parseInt(d.buyoptions[n].total);return!(d.goods.intervalnum1>o)||(FoxUI.toast.show("未达到最低起批数量!"),!1)},changeCartcount:function(o){if(0<$("#menucart").length){var n=$("#menucart").find(".badge");n.length<1?$("#menucart").append('<span class="badge">'+o+"</div>"):n.text(o)}}};return d});